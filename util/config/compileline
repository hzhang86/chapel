#!/usr/bin/env perl

use File::Basename;
use Cwd 'abs_path';


$chpl_home_dir = abs_path(dirname(__FILE__) . "/../../");

#todo -- possibly check inode numbers? handle symbolic links?
if( defined $ENV{"CHPL_HOME"} ) {
  if( abs_path($ENV{"CHPL_HOME"}) ne $chpl_home_dir ) {
    warn "Mismatched CHPL_HOME; got " . abs_path($ENV{"CHPL_HOME"}) . " but expected " . $chpl_home_dir;
  }
} else {
  $ENV{"CHPL_HOME"} = $chpl_home_dir;
}

$ENV{"CHPL_MAKE_HOME"} = $ENV{"CHPL_HOME"};

$chpl_home_dir = $ENV{"CHPL_MAKE_HOME"};

if( $ARGV[0] eq "--home" ) {
  print $chpl_home_dir . "\n";
} elsif( $ARGV[0] eq "--compile" ) {
  0 == system("make -f $chpl_home_dir/runtime/etc/Makefile.include printcompileline") or die "Could not make: $!";
} elsif ( $ARGV[0] eq "--includes-and-defines" ) {
  0 == system("make -f $chpl_home_dir/runtime/etc/Makefile.include printincludesanddefines") or die "Could not make: $!";
} elsif( $ARGV[0] eq "--link" ) {
  0 == system("make -f $chpl_home_dir/runtime/etc/Makefile.include printlinkline") or die "Could not make: $!";
} else {
  print "Unknown argument; try --compile or --link or --includes-and-defines\n";
}

